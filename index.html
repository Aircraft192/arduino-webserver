<html>
    <head>
        <title>Arduino Smarthome - Finn Wiggers</title>
        <meta charset="UTF-8">
        <meta name="description" content="Smarthome-Steuerung mit Arduino - Finn Wiggers - WPU">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
        <link rel="icon" type="image/x-icon" href="/favicon.ico">
        <link rel="stylesheet" href="style.css">

        <script src="/lib.js"></script>
        <script>
            const data_url = '/data.json';
            const config_url = '/config.json';
            let json_data = [];
            let json_config = [];
            fetch(data_url).then(response => response.json()).then(data => {
                json_data = data;
            })
            .catch(error => console.error(error));
            fetch(config_url).then(response => response.json()).then(data => {
                json_config = data;
                load();
            })
            .catch(error => console.error(error));

            function load(){
                for (let i = 2; i <= Object.keys(json_config).length + 1; i++) {
                    document.getElementById("table").innerHTML = document.getElementById("table").innerHTML + "<tr><td>D" + i +"</td><td id=\"description_d" + i +"\"></td><td id=\"mode_d" + i +"\"></td><td id=\"status_d" + i +"\"></td><td id=\"duration_d" + i +"\"></td><td><form onsubmit=\"press('D" + i + "')\"><input type=\"number\" min=\"1\" max=\"10\" step=\"1\" value=\"1\" id=\"button_duration_d" + i +"\"> <input type=\"submit\" value=\"Einschalten\" label=\"duration\"></form></td><td><input type=\"button\" onclick='schalter(\"D" + i + "\")' id=\"switch_d" + i +"\"></td></tr>";
                }
                for (let i = 2; i <= Object.keys(json_config).length + 1; i++) {
                    document.getElementById("description_d" + i).innerHTML = json_config['D' + i].description;
                    document.getElementById("mode_d" + i).innerHTML = json_config['D' + i].mode;
                    if(json_data.status['D' + i] >= 1){
                        document.getElementById("status_d" + i).innerHTML = "Eingeschaltet";
                        document.getElementById("status_d" + i).style.color = "green";
                    }
                    else{
                        document.getElementById("status_d" + i).innerHTML = "Ausgeschaltet";
                        document.getElementById("status_d" + i).style.color = "red";
                    }
                    document.getElementById("duration_d" + i).innerHTML = plural(json_data.status['D' + i], "Sekunde", "n");
                    document.getElementById("button_duration_d" + i).value = json_config['D' + i].duration;
                    if(json_data.status['D' + i] >= 1){
                        document.getElementById("switch_d" + i).value = "Ausschalten";
                    }
                    else{
                        document.getElementById("switch_d" + i).value = "Einschalten";
                    }
                }
                for (let i = 0; i < document.getElementsByTagName("form").length; i++) {
                    console.log(document.getElementsByTagName("form")[i]);
                    document.getElementsByTagName("form")[i].addEventListener('submit', handleForm);
                    
                }
            }
            function handleForm(event) { 
                event.preventDefault(); 
            }

            function press(pin){
            }
            function schalter(pin){
                console.log('/setstatus.php/?' + pin + "=" + -1);
                fetch('/setstatus.php/?' + pin + "=" + -1)
                    .then(response => response.json())
                    .then(data => console.log(data))
                    .catch(error => console.error('Request failed', error));
                return false;
            }
        </script>
    </head>
    <body>
        <h1>Willkommen!</h1>
        <h2>Aktueller Status</h2>
        <table id="table">
            <tr><th>Pin</th><th>Beschreibung</th><th>Modus</th><th>Status</th><th>Dauer</th><th>Impuls</th><th>Schalter</th></tr>
            <!--<tr><td>D2</td><td id="description_d2"></td><td id="mode_d2"></td><td id="status_d2"></td><td id="duration_d2"></td><td><input type="number" min="0.5" max="10" step="0.5" value="1" id="button_duration_d2"> <input type="button" value="Einschalten" onclick='press("d2")'></td><td><input type="button" onclick='schalter("d2")' id="switch_d2"></td></tr>
            <tr><td>D3</td><td id="description_d3"></td><td id="mode_d3"></td><td id="status_d3"></td><td id="duration_d3"></td><td><input type="number" min="0.5" max="10" step="0.5" value="1" id="button_duration_d3"> <input type="button" value="Einschalten" onclick='press("d3")'></td><td><input type="button" onclick='schalter("d2")' id="switch_d3"></td></tr>
            <tr><td>D4</td><td id="description_d4"></td><td id="mode_d4"></td><td id="status_d4"></td><td id="duration_d4"></td><td><input type="number" min="0.5" max="10" step="0.5" value="1" id="button_duration_d4"> <input type="button" value="Einschalten" onclick='press("d4")'></td><td><input type="button" onclick='schalter("d2")' id="switch_d4"></td></tr>
            <tr><td>D5</td><td id="description_d5"></td><td id="mode_d5"></td><td id="status_d5"></td><td id="duration_d5"></td><td><input type="number" min="0.5" max="10" step="0.5" value="1" id="button_duration_d5"> <input type="button" value="Einschalten" onclick='press("d5")'></td><td><input type="button" onclick='schalter("d2")' id="switch_d5"></td></tr>-->
        </table>
        <p id="output"></p>
    </body>
</html>